name: NarrowBelt CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read

jobs:
  code-quality-check:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è¿è¡Œå½±åˆ†èº«æ£€æµ‹ï¼ˆShadow Clone Detectionï¼‰
      run: |
        echo "ğŸ” å¼€å§‹å½±åˆ†èº«ä»£ç æ£€æµ‹..."
        chmod +x scripts/detect-shadow-clones.sh
        ./scripts/detect-shadow-clones.sh
      continue-on-error: false
      
    - name: æ£€æŸ¥ UTC æ—¶é—´ä½¿ç”¨
      run: |
        echo "ğŸ” æ£€æŸ¥æ˜¯å¦è¿è§„ä½¿ç”¨ UTC æ—¶é—´..."
        UTC_COUNT=$(grep -r "DateTime\.UtcNow\|DateTimeOffset\.UtcNow" --include="*.cs" . | grep -v "bin\|obj\|// è¾¹ç•Œè½¬æ¢\|// UTC required" | wc -l)
        if [ $UTC_COUNT -gt 0 ]; then
          echo "âŒ å‘ç° $UTC_COUNT å¤„ä½¿ç”¨UTCæ—¶é—´ï¼Œè¿åé¡¹ç›®è§„èŒƒï¼"
          grep -r "DateTime\.UtcNow\|DateTimeOffset\.UtcNow" --include="*.cs" . | grep -v "bin\|obj\|// è¾¹ç•Œè½¬æ¢\|// UTC required"
          exit 1
        fi
        echo "âœ… æ²¡æœ‰è¿è§„ä½¿ç”¨ UTC æ—¶é—´"
      
    - name: æ£€æŸ¥æŠ€æœ¯å€ºåŠ¡æ–‡æ¡£
      run: |
        echo "ğŸ“‹ éªŒè¯æŠ€æœ¯å€ºåŠ¡æ–‡æ¡£å­˜åœ¨..."
        if [ ! -f "docs/Conventions/æŠ€æœ¯å€ºåŠ¡.md" ]; then
          echo "âŒ æŠ€æœ¯å€ºåŠ¡æ–‡æ¡£ä¸å­˜åœ¨ï¼"
          exit 1
        fi
        echo "âœ… æŠ€æœ¯å€ºåŠ¡æ–‡æ¡£å­˜åœ¨"

  build-and-test:
    name: æ„å»ºå’Œæµ‹è¯•
    runs-on: ubuntu-latest
    needs: code-quality-check
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        
    - name: è¿˜åŸ NuGet åŒ…
      run: dotnet restore ZakYip.NarrowBeltDiverterSorter.sln
      
    - name: ç¼–è¯‘è§£å†³æ–¹æ¡ˆ (Release, è­¦å‘Šè§†ä¸ºé”™è¯¯)
      run: dotnet build ZakYip.NarrowBeltDiverterSorter.sln -c Release --no-restore
      
    - name: è¿è¡Œæµ‹è¯•
      run: dotnet test ZakYip.NarrowBeltDiverterSorter.sln -c Release --no-build --verbosity normal
      
    - name: è¿è¡Œä»¿çœŸæµ‹è¯•ï¼ˆæ˜¾å¼éªŒè¯ï¼‰
      run: dotnet test Tests/ZakYip.NarrowBeltDiverterSorter.Simulator.Tests --no-build -c Release --verbosity normal
