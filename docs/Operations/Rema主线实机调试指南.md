# Rema LM1000H 主线 Bring-up 步骤

本指南介绍如何使用 Rema LM1000H 变频驱动器进行主线的实机调试（Bring-up）。

## 概述

Rema LM1000H 是一款工业级变频驱动器，通过 Modbus RTU 协议与控制系统通信。在实机调试阶段，需要确保：

1. 主线驱动器（变频器）已正确接线并上电
2. Modbus RTU 串口通信正常
3. 编码器反馈信号正确
4. 速度控制响应正常

## 前置条件

### 硬件准备

1. **Rema LM1000H 变频驱动器**
   - 已完成电气接线（三相电源、电机接线）
   - 已连接编码器反馈信号
   - 已连接 RS485 通信线（A+、B-）

2. **串口通信**
   - 确认 PC 串口号（如 COM3 或 /dev/ttyUSB0）
   - RS485 转换器已正确连接
   - 通信线屏蔽层已接地

3. **电机和传动系统**
   - 电机参数已在变频器中设置（P2 组参数）
   - 主线皮带已安装且张紧合适
   - 无机械卡阻

### 变频器参数配置

在开始 Bring-up 之前，需要在变频器面板上设置以下关键参数：

| 参数编号 | 参数名称 | 推荐值 | 说明 |
|---------|---------|--------|------|
| **P0.01** | 运行命令源 | 2 | RS485 通讯控制 |
| **P0.05** | 顶频（基准频率） | 25.0 Hz | 根据实际线速需求调整 |
| **P0.17** | 加速时间 | 5.0 秒 | 根据负载惯量调整 |
| **P0.18** | 减速时间 | 5.0 秒 | 根据负载惯量调整 |
| **P2.00** | 电机型号选择 | 根据电机铭牌 | 异步电机或永磁同步电机 |
| **P2.01** | 电机额定功率 | 根据电机铭牌 | 单位：kW |
| **P2.02** | 电机额定电压 | 根据电机铭牌 | 单位：V |
| **P2.03** | 电机额定电流 | 根据电机铭牌 | 单位：A |
| **P2.04** | 电机额定频率 | 50 Hz | 或 60 Hz（根据电机铭牌） |
| **P2.05** | 电机额定转速 | 根据电机铭牌 | 单位：rpm |
| **P2.06** | 电机额定电流 | 根据电机铭牌 | 用于电流限制保护 |
| **Pd.00** | Modbus 站号 | 1 | 通常使用 1，与配置文件保持一致 |
| **Pd.01** | 通讯波特率 | 38400 | 与配置文件保持一致 |
| **Pd.02** | 数据格式 | 3 (8N1) | 8 位数据，无校验，1 位停止位 |

**重要提示**：
- P2 组参数（电机参数）必须与实际电机铭牌一致
- Pd 组参数（通讯参数）必须与 appsettings.json 中的配置一致
- 修改参数后需要按变频器面板的"确认"键保存

## 配置步骤

### 1. 修改 appsettings.json 配置

编辑 `ZakYip.NarrowBeltDiverterSorter.Host/appsettings.json`，配置 Rema 驱动：

```json
{
  "Sorter": {
    "MainLine": {
      "Mode": "RemaLm1000H",  // 切换为 Rema 驱动
      "Rema": {
        "PortName": "COM3",              // 修改为实际串口号
        "BaudRate": 38400,               // 与变频器 Pd.01 一致
        "DataBits": 8,
        "Parity": "None",                // 与变频器 Pd.02 一致（8N1）
        "StopBits": "One",
        "SlaveAddress": 1,               // 与变频器 Pd.00 一致
        "ReadTimeout": "00:00:01.200",
        "WriteTimeout": "00:00:01.200",
        "ConnectTimeout": "00:00:03",
        "MaxRetries": 3,
        "RetryDelay": "00:00:00.200"
      }
    }
  },
  "RemaLm1000H": {
    "LoopPeriod": "00:00:00.060",        // 控制循环周期（60ms）
    "LimitHz": 25.0,                     // 频率上限，与 P0.05 顶频保持一致
    "MinMmps": 0.0,                      // 最小速度
    "MaxMmps": 3000.0,                   // 最大速度（根据实际需求调整）
    "StableDeadbandMmps": 20.0,         // 稳定死区
    "StableHold": "00:00:01",           // 稳定保持时间
    "TorqueMax": 1000,                   // 最大扭矩（0-1000 = 0-100%）
    "Pid": {
      "Kp": 0.28,                        // 比例系数
      "Ki": 0.028,                       // 积分系数
      "Kd": 0.005                        // 微分系数
    }
  }
}
```

**关键配置说明**：

- **PortName**: Windows 系统使用 `COM3`、`COM4` 等，Linux 系统使用 `/dev/ttyUSB0`、`/dev/ttyS0` 等
- **BaudRate**: 必须与变频器 Pd.01 设置一致
- **SlaveAddress**: 必须与变频器 Pd.00 设置一致
- **LimitHz**: 限制频率上限，应略小于或等于 P0.05 顶频
- **MaxMmps**: 根据线速需求计算，公式：`MaxMmps = LimitHz × 滚筒周长(mm) × 60 / 传动比`

### 2. 验证串口通信

在启动主程序之前，建议先使用 Modbus 调试工具验证通信：

**推荐工具**：
- Windows: Modbus Poll、QModMaster
- Linux: mbpoll、pyModbusTCP

**验证步骤**：

1. 使用 Modbus 工具连接到串口
2. 尝试读取寄存器 C0.26（编码器反馈频率）
3. 尝试写入寄存器 P0.07（限速频率），例如写入 500（对应 5.00 Hz）
4. 观察变频器面板显示是否变化

如果通信失败，请检查：
- 串口号是否正确
- 波特率、数据位、校验位是否与变频器一致
- RS485 线序是否正确（A+ 接 A+，B- 接 B-）
- 变频器站号是否正确

## Bring-up 模式运行

### 启动 Bring-up 模式

使用命令行参数启动主线调试模式：

```bash
cd ZakYip.NarrowBeltDiverterSorter.Host
dotnet run --mode bringup-mainline
```

### 预期日志输出

系统启动后，会每秒输出诊断日志。正常情况下应看到：

```
启动模式: 主线调试模式（主驱控制 + 原点监控）
主线驱动实现: Rema LM1000H
  串口号: COM3
  波特率: 38400
  数据位: 8
  奇偶校验: None
  停止位: One
  站号: 1
  读取超时: 1200 ms
  写入超时: 1200 ms
  最大重试: 3

[主线状态] 目标速度: 1000.0 mm/s, 实际速度: 998.5 mm/s, 速度稳定: 是
[Rema 连接] 串口: COM3, 波特率: 38400, 站号: 1
[Rema 命令] 最后成功下发速度: 1000.0 mm/s (2.3秒前)
[Rema 反馈] C0.26 寄存器值: 1654, 反馈频率: 16.54 Hz, 换算线速: 998.5 mm/s
```

**日志说明**：

1. **[主线状态]**: 目标速度、实际速度、速度稳定性
2. **[Rema 连接]**: 串口配置和站号（用于排查连接问题）
3. **[Rema 命令]**: 最近一次成功下发的目标速度及时间
4. **[Rema 反馈]**: C0.26 寄存器原始值、反馈频率（Hz）、换算后的线速度（mm/s）

### 诊断和排查

#### 问题 1：通讯失败

**症状**：日志显示连续读取失败

```
读取主线速度失败（第 1/5 次）
主线速度反馈不可用 - 连续 5 次读取失败
```

**排查步骤**：

1. 检查串口号是否正确
   ```bash
   # Windows
   在设备管理器中查看串口号
   
   # Linux
   ls /dev/ttyUSB* /dev/ttyS*
   ```

2. 检查 RS485 连线
   - 确认 A+、B- 接线正确
   - 确认屏蔽层接地
   - 尝试对调 A+ 和 B-（某些设备标注不一致）

3. 检查变频器通讯参数
   - Pd.00 站号是否与配置一致
   - Pd.01 波特率是否与配置一致
   - Pd.02 数据格式是否为 8N1

4. 使用 Modbus 调试工具验证通信

#### 问题 2：速度反馈为 0

**症状**：日志显示实际速度始终为 0

```
[Rema 反馈] C0.26 寄存器值: 0, 反馈频率: 0.00 Hz, 换算线速: 0.0 mm/s
```

**排查步骤**：

1. 检查编码器接线
   - 确认编码器电源（通常为 DC 24V 或 5V）
   - 确认 A、B、Z 相信号接线
   - 使用万用表测量编码器输出信号

2. 检查变频器编码器参数
   - 确认 P5 组参数（编码器参数）已正确设置
   - 确认编码器线数（PPR）设置正确

3. 手动转动电机，观察 C0.26 寄存器值是否变化

#### 问题 3：速度不稳定

**症状**：实际速度大幅波动，无法稳定

```
[主线状态] 目标速度: 1000.0 mm/s, 实际速度: 950.0 mm/s, 速度稳定: 否
[主线状态] 目标速度: 1000.0 mm/s, 实际速度: 1050.0 mm/s, 速度稳定: 否
```

**排查步骤**：

1. 调整 PID 参数
   - 减小 Kp（比例系数）以降低震荡
   - 增大 Ki（积分系数）以减小稳态误差
   - 适当增加 Kd（微分系数）以改善响应

2. 检查机械系统
   - 确认皮带张紧度合适
   - 检查滚筒轴承是否正常
   - 检查是否有机械卡阻或异响

3. 调整变频器参数
   - 增加加减速时间（P0.17、P0.18）
   - 调整转矩提升（P0.13）
   - 调整 V/F 曲线（P0.14-P0.16）

#### 问题 4：主线无法启动

**症状**：日志显示初始化失败

```
初始化雷马 LM1000H 主线驱动失败
主线驱动初始化失败，主线控制服务将不会启动
```

**排查步骤**：

1. 检查变频器面板显示
   - 是否有故障代码（如 E01、E02 等）
   - 按复位键清除故障

2. 检查电源和接线
   - 确认三相电源正常
   - 确认电机接线正确（U、V、W 或 R、S、T）
   - 确认无短路或接地故障

3. 检查保护参数
   - 检查过流保护（P3 组）
   - 检查过压/欠压保护（P4 组）
   - 适当放宽保护阈值（谨慎操作）

## 速度标定

在 Bring-up 模式下，需要标定线速度与频率的换算关系。

### 标定步骤

1. **测量滚筒周长**
   ```
   周长(mm) = π × 直径(mm)
   例如：直径 200mm 的滚筒，周长 = 3.14159 × 200 ≈ 628.3 mm
   ```

2. **确定传动比**
   ```
   传动比 = 电机转速 / 滚筒转速
   例如：电机 1500 rpm，滚筒 500 rpm，则传动比 = 3:1
   ```

3. **计算换算系数**
   ```
   线速度(mm/s) = 频率(Hz) × 滚筒周长(mm) × 60 / 传动比
   
   例如：
   滚筒周长 = 628.3 mm
   传动比 = 3:1
   频率 = 16.54 Hz
   线速度 = 16.54 × 628.3 × 60 / 3 ≈ 207,276 mm/min ≈ 3,454 mm/s
   ```

4. **验证换算系数**
   - 使用激光测速仪或秒表测量实际线速
   - 对比日志中的换算线速度
   - 如有偏差，调整 RemaScaling.cs 中的换算系数

### 换算系数配置

换算系数在 `RemaScaling.cs` 中定义：

```csharp
public static class RemaScaling
{
    // Hz 到 mm/s 的换算系数
    public const decimal HzToMmps = 60.377m;
    
    // mm/s 到 Hz 的换算系数
    public const decimal MmpsToHz = 1m / HzToMmps;
}
```

如需修改，请根据实际测量结果调整 `HzToMmps` 的值。

## E2E 仿真测试

Bring-up 模式下也可以运行端到端仿真测试，验证主线驱动在不同负载下的表现。

### 运行 E2E 仿真

```bash
cd ZakYip.NarrowBeltDiverterSorter.Simulation
dotnet run --scenario e2e-report --parcel-count 50 --output rema-e2e-report.json
```

**注意**：
- E2E 仿真会模拟包裹流和负载变化
- 实机模式下，主线速度反馈来自真实编码器
- 可以观察 PID 控制在不同负载下的响应特性

### 分析仿真报告

仿真完成后，检查 `rema-e2e-report.json`：

```json
{
  "totalParcels": 50,
  "sortedParcels": 48,
  "successRate": 0.96,
  "averageSpeed": 998.5,
  "speedStability": 0.95,
  "...": "..."
}
```

关键指标：
- **averageSpeed**: 平均线速度，应接近目标速度
- **speedStability**: 速度稳定性，应 > 0.9
- **successRate**: 分拣成功率，应 > 0.95

## 切换到仿真模式

如需切换回仿真模式（用于离线开发和测试）：

```json
{
  "Sorter": {
    "MainLine": {
      "Mode": "Simulated"  // 切换回仿真驱动
    }
  }
}
```

重新启动程序即可生效。

## 注意事项

### 安全事项

1. **紧急停止**
   - 确保现场有紧急停止按钮
   - 在 Bring-up 期间，操作人员应随时准备按下紧急停止

2. **速度限制**
   - 首次调试时，将 MaxMmps 设置为较低值（如 1000 mm/s）
   - 逐步提高速度，观察机械系统响应

3. **电气安全**
   - 所有电气操作应由专业电工完成
   - 确保设备接地良好
   - 使用隔离变压器或 UPS 供电

### 操作建议

1. **逐步验证**
   - 先验证通讯（读写寄存器）
   - 再验证速度反馈（手动转动电机）
   - 最后验证速度控制（设置目标速度）

2. **记录参数**
   - 记录所有变频器参数设置
   - 记录调试过程中的异常现象
   - 记录最终的 PID 参数和换算系数

3. **定期检查**
   - 每次启动前检查接线和参数
   - 定期检查编码器和传感器状态
   - 定期备份配置文件和数据库

## 常见问题 FAQ

### Q1: 如何查看当前使用的串口？

A: 查看启动日志，会显示：
```
主线驱动实现: Rema LM1000H
  串口号: COM3
```

### Q2: 如何修改目标速度？

A: 修改 `MainLineControlOptions` 中的 `TargetSpeedMmps` 参数（存储在 LiteDB 数据库中），或通过配置 API 动态修改。

### Q3: Bring-up 模式和正常模式有什么区别？

A: Bring-up 模式：
- 只启动主线控制和原点监控
- 不启动上游 API、分拣规则、格口吐件
- 每秒输出详细的诊断日志
- 适用于硬件调试和参数整定

正常模式：
- 启动所有 Worker 和服务
- 与上游系统通信
- 执行完整的分拣流程
- 适用于生产运行

### Q4: 如何判断 PID 参数是否合适？

A: 观察速度曲线：
- **震荡过大**：减小 Kp
- **响应缓慢**：增大 Kp
- **稳态误差**：增大 Ki
- **超调过大**：减小 Kp，增大 Kd

建议使用示波器或数据采集器记录速度曲线，进行定量分析。

## 相关文档

- [BringUpGuide.md](BringUpGuide.md) - 通用 Bring-up 模式指南
- [NarrowBeltDesign.md](NarrowBeltDesign.md) - 窄带分拣机设计文档
- [SAFETY_CONTROL.md](SAFETY_CONTROL.md) - 安全控制设计
- Rema LM1000H 变频器说明书（由设备厂商提供）

## 联系支持

如有技术问题或需要现场支持，请联系技术团队。
