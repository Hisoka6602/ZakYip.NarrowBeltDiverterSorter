# 技术债务文档

本文档记录项目中所有已识别的技术债务。每个 PR 提交前**必须**通读本文档，并在 PR 中说明是否引入了新的技术债务或解决了现有技术债务。

> **⚠️ 强制要求**：提交 PR 前必须解决所有**高优先级**技术债务，或在 PR 中明确说明无法解决的原因。

---

## 目录

1. [当前技术债务清单](#当前技术债务清单)
2. [影分身代码（代码重复）](#影分身代码代码重复)
3. [配置管理债务](#配置管理债务)
4. [测试债务](#测试债务)
5. [实现未完成的功能](#实现未完成的功能)
6. [架构债务](#架构债务)
7. [技术债务添加流程](#技术债务添加流程)
8. [技术债务解决流程](#技术债务解决流程)

---

## 当前技术债务清单

### 统计信息
- **总债务数量**: 20
- **高优先级**: 4
- **中优先级**: 13
- **低优先级**: 3
- **最后更新**: 2025-12-07
- **已解决**: 4 (TD-CLONE-001, TD-CLONE-002, TD-CLONE-003, TD-CLONE-006)

---

## 影分身代码（代码重复）

### ✅ TD-CLONE-001: 重复的事件参数记录类型 [已解决 - 2025-12-07]

**描述**: 多个事件参数类型在不同命名空间中重复定义

**解决方案**: 
- 删除了 Core 层的重复定义（SafetyStateChangedEventArgs, LineRunStateChangedEventArgs, ParcelRoutedEventArgs, ParcelLifecycleChangedEventArgs, SensorTriggeredEventArgs, CartPassedEventArgs）
- 保留 Observability.Events 作为事件总线通信的规范定义
- 在 Core 层保留了最小的 SafetyInputChangedEventArgs 用于 ILineSafetyOrchestrator 接口定义
- 更新了所有引用以使用规范版本

**PR**: #copilot/handle-all-debts

---

### ✅ TD-CLONE-002: 重复的 DTO 类型 [已解决 - 2025-12-07]

**描述**: 多个 DTO 类型在 Host.SignalR 和 Host.Contracts.SignalR 两处重复定义

**解决方案**:
- 删除了 Host.SignalR.LiveViewDtos.cs 中的重复定义
- 保留 Host.Contracts.SignalR.LiveViewDtos.cs 作为规范定义
- 更新了所有引用以使用 Contracts 层版本

**PR**: #copilot/handle-all-debts

---

### ✅ TD-CLONE-003: 重复的测试类名 [已解决 - 2025-12-07]

**描述**: 多个测试文件使用相同的类名 `UnitTest1`

**解决方案**:
- 重命名 E2ETests/UnitTest1.cs 为 EndToEndSimulationTests.cs（匹配实际类名）
- 删除 3 个空的 UnitTest1.cs 模板文件（Core.Tests, Execution.Tests, Ingress.Tests）

**PR**: #copilot/handle-all-debts

---

### TD-CLONE-004: 重复的 Dispose 方法实现 [中优先级]

**描述**: 32 处 `Dispose()` 方法实现，可能存在模式重复

**解决方案**: 
1. 审查所有 Dispose 实现
2. 提取公共模式到基类或辅助类
3. 使用标准的 Dispose 模式

---

### TD-CLONE-005: 重复的连接管理方法 [中优先级]

**描述**: 多个类实现相似的连接管理方法

**重复方法**:
```
ConnectAsync (8处)
DisconnectAsync (5处)
StartAsync (6处)
StopAsync (6处)
```

**解决方案**:
1. 定义统一的连接管理接口
2. 提取公共实现到基类
3. 减少代码重复

---

## 配置管理债务

### TD-CONFIG-001: 配置项未迁移到 LiteDB [高优先级]

**描述**: 多个配置项仍在 Program.cs 中硬编码，需要迁移到 LiteDB

**位置**: `Host/ZakYip.NarrowBeltDiverterSorter.Host/Program.cs`

**待迁移配置**:
- Line 162: 格口IO监视器选项
- Line 166: 小车参数寄存器
- Line 178: 格口映射
- Line 190: 现场总线客户端
- Line 206: 格口布局
- Line 210: 目标格口分配策略

**解决方案**: 
1. 为每类配置创建对应的 LiteDB 存储
2. 实现配置 API 端点
3. 从 Program.cs 移除硬编码配置

---

### TD-CONFIG-002: 硬编码的降级格口ID [高优先级]

**描述**: 降级格口 ID 硬编码为 999

**位置**: `Execution/ZakYip.NarrowBeltDiverterSorter.Execution/Orchestration/ParcelSortingOrchestrator.cs:38`

**代码**:
```csharp
// TODO: 从配置读取降级格口ID，这里使用默认值 999
```

**解决方案**: 
1. 添加配置项 `FallbackChuteId`
2. 从配置读取而非硬编码
3. 提供 API 端点修改

---

### TD-CONFIG-003: 错误格口ID配置 [中优先级]

**描述**: 错误格口 ID 默认为 9999，但在不同地方有不同的值

**位置**: 
- `Core/ZakYip.NarrowBeltDiverterSorter.Core/Configuration/UpstreamRoutingOptions.cs`

**解决方案**: 统一错误格口 ID 的配置管理

---

## 测试债务

### TD-TEST-001: 测试未完成 - InfeedSensorMonitorTests [中优先级]

**描述**: 多个测试标记为 TODO 但未实现

**位置**: `Tests/ZakYip.NarrowBeltDiverterSorter.Ingress.Tests/Infeed/InfeedSensorMonitorTests.cs`

**未完成的测试**:
- Line 41: 验证 IEventBus.PublishAsync 被调用
- Line 62: 验证 IEventBus.PublishAsync 没有被调用
- Line 70: 测试顺序ParcelId生成
- Line 76: 测试快速检测处理

**解决方案**: 完成这些测试的实现

---

### TD-TEST-002: 测试需要重写 - ParcelLifecycleTrackerTests [中优先级]

**描述**: 测试需要更新以使用 IEventBus

**位置**: `Tests/ZakYip.NarrowBeltDiverterSorter.Core.Tests/Parcels/ParcelLifecycleTrackerTests.cs:33`

**解决方案**: 更新测试使用 IEventBus 验证事件发布

---

### TD-TEST-003: E2E测试需要重写 [中优先级]

**描述**: E2E 测试需要使用 IEventBus 重写

**位置**: `Tests/ZakYip.NarrowBeltDiverterSorter.E2ETests/UnitTest1.cs`

**待重写测试**:
- Line 28, 34, 40

**解决方案**: 重写 E2E 测试使用 IEventBus

---

## 实现未完成的功能

### TD-IMPL-001: 传感器端口未实现 [高优先级]

**描述**: 生产环境所需的传感器端口未实现

**位置**: `Host/ZakYip.NarrowBeltDiverterSorter.Host/Program.cs`

**未实现组件**:
- Line 588: 传感器端口
- Line 771: IOriginSensorPort
- Line 778: IInfeedSensorPort

**影响**: 无法在实际硬件环境中运行

**解决方案**: 
1. 实现真实硬件的传感器端口
2. 配置硬件参数
3. 测试与验证

---

### TD-IMPL-002: 安全输入监控器未实现 [高优先级]

**描述**: 生产模式下的真实安全输入监控器未实现

**位置**: `Host/ZakYip.NarrowBeltDiverterSorter.Host/Program.cs:680`

**影响**: 无法监控实际安全状态

**解决方案**: 实现真实的安全输入监控器

---

### TD-IMPL-003: 现场总线客户端未实现 [高优先级]

**描述**: FieldBusClient 未实现

**位置**: `Host/ZakYip.NarrowBeltDiverterSorter.Host/Program.cs:797`

**影响**: 无法与现场总线设备通讯

**解决方案**: 实现 FieldBusClient

---

### TD-IMPL-004: 仿真启动逻辑未完成 [中优先级]

**描述**: 仿真控制器中的启动逻辑未实现

**位置**: `Host/ZakYip.NarrowBeltDiverterSorter.Host/Controllers/SimulationsController.cs`

**未完成功能**:
- Line 73: 系统状态检查逻辑
- Line 77: 通过面板服务发送启动信号
- Line 85: 启动后台服务执行仿真

**解决方案**: 完成仿真启动的完整实现

---

### TD-IMPL-005: 生产硬件驱动未实现 [高优先级]

**描述**: 仿真驱动需要在生产模式下替换为实际硬件实现

**位置**: `Execution/ZakYip.NarrowBeltDiverterSorter.Execution/Vendors/Simulated/StubInfeedConveyorPort.cs:7`

**影响**: 无法连接实际硬件

**解决方案**: 
1. 实现各厂商的实际硬件驱动
2. 配置驱动切换机制
3. 测试与验证

---

### TD-IMPL-006: CartRingBuilder事件发布未实现 [中优先级]

**描述**: CartRingBuilder.RaiseCartPassed 方法当前为空实现，未发布小车通过事件到事件总线

**位置**: `Core/ZakYip.NarrowBeltDiverterSorter.Core/Domain/Tracking/CartRingBuilder.cs:111`

**影响**: 
- 小车通过事件未被发布，依赖此事件的订阅者无法接收通知
- 该方法在第87行被调用但无实际效果（silent no-op）

**解决方案**: 
1. 为 CartRingBuilder 添加 IEventBus 依赖注入
2. 在 RaiseCartPassed 方法中发布 CartPassedEventArgs 事件
3. 更新依赖注入配置

---

### TD-IMPL-007: ParcelLifecycleTracker事件发布未实现 [中优先级]

**描述**: ParcelLifecycleTracker.UpdateStatus 方法未发布包裹生命周期变化事件到事件总线

**位置**: `Core/ZakYip.NarrowBeltDiverterSorter.Core/Application/ParcelLifecycleTracker.cs:93`

**影响**: 
- 包裹状态变化事件未被发布，监控和可观测性功能缺失
- IEventBus 已在 Core.Abstractions 中定义并可用，实现该功能不存在技术障碍

**解决方案**: 
1. 为 ParcelLifecycleTracker 添加 IEventBus 依赖注入
2. 在 UpdateStatus 方法中创建并发布 ParcelLifecycleChangedEventArgs 事件
3. 更新依赖注入配置

---

## 架构债务

### TD-ARCH-001: TCP连接资源未释放 [中优先级]

**描述**: TCP 连接资源未正确释放

**位置**: `Communication/ZakYip.NarrowBeltDiverterSorter.Communication/Upstream/TcpSortingRuleEngineClient.cs:76`

**解决方案**: 实现 Dispose 模式正确释放 TCP 连接

---

### TD-ARCH-002: 缺少日志记录 [低优先级]

**描述**: 某些关键操作缺少日志记录

**位置**: `Communication/ZakYip.NarrowBeltDiverterSorter.Communication/UpstreamSortingApiClient.cs:77`

**解决方案**: 添加适当的日志记录

---

### TD-ARCH-003: 小车位置预测功能缺失 [低优先级]

**描述**: 缺少小车上车预测的滑动平均速度维护

**位置**: `Core/ZakYip.NarrowBeltDiverterSorter.Core/Domain/Tracking/CartPositionTracker.cs:14`

**解决方案**: 实现主线速度滑动平均计算以支持上车预测

---

## 技术债务添加流程

### 当引入新的技术债务时：

1. **评估是否必要**
   - 是否有更好的立即解决方案？
   - 是否真的需要延后处理？

2. **记录到本文档**
   - 分配唯一的债务编号 (TD-XXX-NNN)
   - 记录位置、描述、影响
   - 设置优先级（高/中/低）
   - 提供解决方案建议

3. **在代码中标记**
   ```csharp
   // TD-IMPL-001: 传感器端口未实现
   // TODO: 实现真实硬件的传感器端口
   ```

4. **在 PR 中说明**
   - 在 PR 描述中列出新增的技术债务
   - 说明为何需要引入
   - 估计解决时间

### 技术债务编号规则

- `TD-CLONE-NNN`: 代码重复（影分身）
- `TD-CONFIG-NNN`: 配置管理
- `TD-TEST-NNN`: 测试相关
- `TD-IMPL-NNN`: 功能实现
- `TD-ARCH-NNN`: 架构设计
- `TD-PERF-NNN`: 性能优化
- `TD-SEC-NNN`: 安全问题
- `TD-DOC-NNN`: 文档缺失

---

## 技术债务解决流程

### 当解决技术债务时：

1. **从本文档中选择债务**
   - 优先选择高优先级债务
   - 考虑依赖关系

2. **在 PR 中标注**
   - PR 标题包含 `[解决技术债务 TD-XXX-NNN]`
   - PR 描述中说明如何解决

3. **更新本文档**
   - 将已解决债务移到"已解决"部分
   - 记录解决日期和 PR 编号
   - 更新统计信息

4. **清理代码标记**
   - 删除相关的 TODO 注释
   - 更新相关文档

---

## PR 提交检查清单

在提交每个 PR 前，必须检查：

- [ ] 已通读本技术债务文档
- [ ] 没有引入新的代码重复（影分身）
- [ ] 如引入新技术债务，已记录到本文档
- [ ] 如解决现有技术债务，已更新本文档
- [ ] 高优先级技术债务已全部解决或有明确说明
- [ ] PR 描述中包含技术债务变更说明
- [ ] 已运行 `./check-pr.sh` 验证通过

---

## 自动化检测

### 检测影分身代码

运行以下脚本检测代码重复：

```bash
./scripts/detect-shadow-clones.sh
```

### 检测技术债务标记

检测代码中的 TODO/FIXME/HACK 标记：

```bash
grep -rn "TODO\|FIXME\|HACK" --include="*.cs" . | grep -v "/bin/\|/obj/" | wc -l
```

### 验证配置迁移

检查是否有未迁移的配置：

```bash
grep -rn "TODO.*配置\|TODO.*LiteDB" --include="*.cs" Host/
```

---

## 已解决的技术债务

### 2025-12-06
- 暂无

---

## 已解决的技术债务

### 2025-12-07
- ✅ **TD-CLONE-001**: 重复的事件参数记录类型（9种EventArgs类型重复） - 已删除Core层重复，统一使用Observability.Events
- ✅ **TD-CLONE-002**: 重复的DTO类型（9种DTO类型重复） - 已删除Host.SignalR重复，统一使用Host.Contracts.SignalR
- ✅ **TD-CLONE-003**: 重复的测试类名UnitTest1（4处） - 已重命名E2E测试，删除3个空模板文件

### 2025-12-06
- 暂无

---

## 参考文档

- [代码审查检查清单](./代码审查检查清单.md)
- [项目规则集](./项目规则集.md)
- [架构硬性规则](./架构硬性规则.md)
- [CONTRIBUTING.md](../../CONTRIBUTING.md)

---

**版本**: v1.1  
**最后更新**: 2025-12-07  
**维护者**: ZakYip Team

**本文档是 PR 流程的强制性组成部分，所有贡献者必须遵守。**
